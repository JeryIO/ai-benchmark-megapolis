# -*- coding: utf-8 -*-
"""Промпты для тестирования LLM на задаче планирования строительства."""

from typing import List, Dict, Any


PROMPT_BASIC = """Ты — главный инженер проекта капитального строительства с 20-летним опытом планирования работ по СНиП и ГОСТ.

## ЗАДАЧА
Определи технологические зависимости между строительными работами. Для каждой задачи укажи, какие работы должны быть завершены ДО её начала.

## ПРАВИЛА ОПРЕДЕЛЕНИЯ ЗАВИСИМОСТЕЙ

### Технологическая последовательность строительства:
1. Подготовительный период → Земляные работы → Фундаменты → Конструкции ниже 0.000 → Конструкции выше 0.000 → Кровля → Инженерные сети → Отделка → Благоустройство

### Принципы назначения зависимостей:
- Работа зависит ТОЛЬКО от работ, которые ТЕХНОЛОГИЧЕСКИ предшествуют ей
- Работы одного типа в разных зонах могут выполняться ПАРАЛЛЕЛЬНО (пустой depends_on)
- Первые работы в проекте не имеют зависимостей (depends_on = [])
- Указывай только ПРЯМЫЕ зависимости (не транзитивные)

## ФОРМАТ ОТВЕТА
Верни JSON-массив. Каждый элемент содержит:
- "name": точное название задачи (скопируй без изменений)
- "depends_on": массив названий задач-предшественников

```json
[
  {"name": "Название задачи 1", "depends_on": []},
  {"name": "Название задачи 2", "depends_on": ["Название задачи 1"]}
]
```

## КРИТИЧЕСКИ ВАЖНО
- Верни ВСЕ задачи из входного списка (100% покрытие)
- Копируй названия ТОЧНО, символ в символ
- Ответ должен быть валидным JSON без markdown-разметки

## ВХОДНЫЕ ДАННЫЕ
"""


PROMPT_FEW_SHOT = """Ты — главный инженер проекта капитального строительства. Твоя задача — определить технологические зависимости между работами для построения сетевого графика.

## ПРИМЕРЫ ОПРЕДЕЛЕНИЯ ЗАВИСИМОСТЕЙ

### Пример 1: Земляные и фундаментные работы
Вход:
```
#1 Срезка растительного слоя
#2 Разработка котлована экскаватором
#3 Устройство песчаной подготовки под фундаменты
#4 Устройство бетонной подготовки
#5 Монтаж фундаментных блоков
```

Выход:
```json
[
  {"name": "Срезка растительного слоя", "depends_on": []},
  {"name": "Разработка котлована экскаватором", "depends_on": ["Срезка растительного слоя"]},
  {"name": "Устройство песчаной подготовки под фундаменты", "depends_on": ["Разработка котлована экскаватором"]},
  {"name": "Устройство бетонной подготовки", "depends_on": ["Устройство песчаной подготовки под фундаменты"]},
  {"name": "Монтаж фундаментных блоков", "depends_on": ["Устройство бетонной подготовки"]}
]
```

### Пример 2: Параллельные работы в разных помещениях
Вход:
```
#1 Штукатурка стен помещение 101
#2 Штукатурка стен помещение 102
#3 Штукатурка стен помещение 103
#4 Окраска стен помещение 101
```

Выход:
```json
[
  {"name": "Штукатурка стен помещение 101", "depends_on": []},
  {"name": "Штукатурка стен помещение 102", "depends_on": []},
  {"name": "Штукатурка стен помещение 103", "depends_on": []},
  {"name": "Окраска стен помещение 101", "depends_on": ["Штукатурка стен помещение 101"]}
]
```

### Пример 3: Инженерные сети
Вход:
```
#1 Прокладка труб водоснабжения
#2 Прокладка труб канализации
#3 Монтаж сантехприборов
#4 Пусконаладочные работы водоснабжения
```

Выход:
```json
[
  {"name": "Прокладка труб водоснабжения", "depends_on": []},
  {"name": "Прокладка труб канализации", "depends_on": []},
  {"name": "Монтаж сантехприборов", "depends_on": ["Прокладка труб водоснабжения", "Прокладка труб канализации"]},
  {"name": "Пусконаладочные работы водоснабжения", "depends_on": ["Монтаж сантехприборов"]}
]
```

## ПРАВИЛА
1. Работы выполняются в технологической последовательности строительства
2. Однотипные работы в разных зонах/помещениях — ПАРАЛЛЕЛЬНО
3. Монтаж оборудования — после прокладки сетей
4. Отделочные работы — после монтажа сетей
5. Пусконаладка — после монтажа оборудования

## ФОРМАТ ОТВЕТА
Только JSON-массив, без markdown-разметки и пояснений.

## ЗАДАЧИ ДЛЯ АНАЛИЗА
"""


PROMPT_EXPERT = """# РОЛЬ
Ты — директор по планированию крупной строительной компании с опытом реализации объектов капитального строительства стоимостью свыше 1 млрд рублей. Ты эксперт в:
- Разработке календарно-сетевых графиков по СП 48.13330.2019
- Технологии строительного производства
- Организации строительства по МДС 12-81.2007
- Системах управления проектами (Primavera, MS Project)

# КОНТЕКСТ
Тебе предоставлен перечень работ из локальных сметных расчетов (ЛСР) строительного проекта. Необходимо определить технологические зависимости для построения сетевого графика производства работ.

# ТЕХНОЛОГИЧЕСКАЯ ПОСЛЕДОВАТЕЛЬНОСТЬ СТРОИТЕЛЬСТВА

## Этап 1: Подготовительный период
- Геодезические работы (разбивка осей, вынос отметок)
- Подготовка территории (снос, демонтаж, расчистка)
- Срезка растительного слоя
- Устройство временных дорог и площадок

## Этап 2: Земляные работы
- Разработка котлована/траншей
- Устройство водоотлива/водопонижения
- Обратная засыпка (после фундаментов)

## Этап 3: Фундаменты (цикл "0")
- Устройство оснований (песчаная, щебеночная, бетонная подготовка)
- Свайные работы (при наличии)
- Монтаж/устройство фундаментов
- Гидроизоляция фундаментов

## Этап 4: Конструкции подземной части
- Стены подвала
- Перекрытие над подвалом
- Гидроизоляция стен

## Этап 5: Конструкции надземной части
- Каркас (колонны, балки, ригели)
- Стены и перегородки
- Перекрытия (поэтажно)
- Лестницы

## Этап 6: Кровля
- Несущие конструкции крыши
- Утепление
- Кровельное покрытие

## Этап 7: Заполнение проемов
- Окна
- Двери наружные
- Двери внутренние (после отделки)

## Этап 8: Инженерные системы
### Последовательность внутри этапа:
1. Прокладка магистралей и стояков
2. Разводка по этажам/помещениям
3. Установка оборудования и приборов
4. Пусконаладочные работы

### Системы могут выполняться параллельно:
- Отопление и вентиляция
- Водоснабжение и канализация
- Электроснабжение и слаботочные системы

## Этап 9: Отделочные работы
### Последовательность:
1. Штукатурные работы
2. Устройство полов (стяжка)
3. Облицовка/покраска стен
4. Устройство покрытий полов
5. Устройство потолков

## Этап 10: Благоустройство
- После завершения основных работ на здании
- Асфальтирование, озеленение, малые формы

# ПРИНЦИПЫ ОПРЕДЕЛЕНИЯ ЗАВИСИМОСТЕЙ

## Обязательные зависимости (ВСЕГДА назначать):
- Конструкции → после фундаментов
- Кровля → после несущих конструкций
- Инженерные сети → после возведения конструкций этажа
- Отделка → после инженерных сетей
- Оборудование → после прокладки сетей

## Параллельные работы (БЕЗ зависимостей между собой):
- Однотипные работы в разных помещениях/секциях
- Разные инженерные системы (ОВ, ВК, ЭС)
- Работы на разных этажах (если конструктивно независимы)

## НЕ назначать зависимости:
- Между работами разных подрядчиков без технологической связи
- Транзитивные зависимости (если A→B→C, то связь A→C не нужна)

# ФОРМАТ ОТВЕТА
Верни ТОЛЬКО JSON-массив без дополнительного текста:

[
  {"name": "Точное название задачи", "depends_on": ["Предшественник 1", "Предшественник 2"]},
  ...
]

# ТРЕБОВАНИЯ К КАЧЕСТВУ
1. 100% покрытие — каждая входная задача должна быть в ответе
2. Точные названия — копируй без изменений
3. Валидный JSON — проверь синтаксис
4. Только прямые зависимости — без транзитивных связей
5. Логичная последовательность — соответствие технологии строительства

# ДАННЫЕ ДЛЯ АНАЛИЗА
"""


PROMPTS = {
    "basic": PROMPT_BASIC,
    "few_shot": PROMPT_FEW_SHOT,
    "expert": PROMPT_EXPERT,
}


def get_prompt_template(prompt_type: str = "expert") -> str:
    """Получить шаблон промпта по типу."""
    if prompt_type not in PROMPTS:
        raise ValueError(f"Неизвестный тип промпта: {prompt_type}. Доступные: {', '.join(PROMPTS.keys())}")
    return PROMPTS[prompt_type]


def format_tasks(tasks: List[Dict[str, Any]]) -> str:
    """Форматирование списка задач для промпта."""
    lines = []
    for i, task in enumerate(tasks, 1):
        name = task.get("name", "")
        chapter = task.get("chapter", "")
        group = task.get("group", "")

        extra = chapter or group
        if extra:
            lines.append(f"#{i} {name} [{extra}]")
        else:
            lines.append(f"#{i} {name}")

    return "\n".join(lines)


def build_prompt(prompt_template: str, tasks: List[Dict[str, Any]]) -> str:
    """Собрать полный промпт из шаблона и списка задач."""
    return prompt_template + format_tasks(tasks)
